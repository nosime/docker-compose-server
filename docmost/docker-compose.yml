networks:
  cloudflare_network:
    external: true

services:
  # Docmost PostgreSQL Database
  docmost_postgres:
    image: postgres:16-alpine
    container_name: docmost_postgres
    restart: unless-stopped
    networks:
      - cloudflare_network
    volumes:
      - docmost_postgres_data:/var/lib/postgresql/data
    environment:
      - TZ=Asia/Ho_Chi_Minh
      - POSTGRES_USER=docmost
      - POSTGRES_PASSWORD=P9k7m2X8n4R6w1E5t3Y7u9I0o2A4s6D8
      - POSTGRES_DB=docmost
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U docmost -d docmost']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Docmost Redis Cache
  docmost_redis:
    image: redis:7-alpine
    container_name: docmost_redis
    restart: unless-stopped
    networks:
      - cloudflare_network
    volumes:
      - docmost_redis_data:/data
    environment:
      - TZ=Asia/Ho_Chi_Minh
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  # Docmost Main Server - Team documentation platform
  docmost:
    image: docmost/docmost:latest
    container_name: docmost_server
    restart: unless-stopped
    networks:
      - cloudflare_network
    ports:
      - "127.0.0.1:3009:3000"
    volumes:
      - ../opt/docmost/data:/app/data
      - ../opt/docmost/uploads:/app/uploads
    environment:
      - TZ=Asia/Ho_Chi_Minh
      - NODE_ENV=production
      - DATABASE_URL=postgresql://docmost:P9k7m2X8n4R6w1E5t3Y7u9I0o2A4s6D8@docmost_postgres:5432/docmost
      - REDIS_URL=redis://docmost_redis:6379
      - APP_SECRET=A7j9K2m5N8p1Q4r7S0t3V6x9Z2b5C8f1G4h7J0k3M6n9P2q5R8s1T4v7W0z3
      - APP_URL=https://docmost.nosime.org/
      - NEXTAUTH_SECRET=X3y6B9e2F5h8I1k4M7n0P3q6S9t2V5x8Z1b4D7g0H3j6K9m2N5p8Q1r4T7u0
      - STORAGE_DRIVER=local
      - MAIL_DRIVER=smtp
      - MAIL_HOST=smtp.gmail.com
      - MAIL_PORT=587
      - MAIL_SECURE=true
      - MAIL_USER=nosime404@gmail.com
      - MAIL_PASS=uguqajmcforunxda
      - MAIL_FROM_ADDRESS=noreply@nosime.org
      - MAIL_FROM_NAME=Docmost - Nosime
    depends_on:
      docmost_postgres:
        condition: service_healthy
      docmost_redis:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:3000/api/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  docmost_postgres_data:
  docmost_redis_data:
